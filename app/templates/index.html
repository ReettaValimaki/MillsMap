{% extends "layout.html" %}
{% block content %}
<html>
<body>
    <div class="container-fluid m-5">
        <div class="row">
            <div class="col-3"> 
                <div class="row">
                    <h1>Logo</h1>
                </div>
                <hr>
                <div class="row">
                    <h1>Background Information</h1>
                         <p>Con nonummy sem integer interdum volutpat dis eget eligendi aliquip dolorum magnam. Lorem ipsum dolor si amet taciti sunt torquent ipsam proin montes quia netus quo minima sint. At aenean etiam suspendisse ultricies auctor per nihil nisi. Ullam fermentum urna varius et saepe labore dignissim consectetuer fusce elementum. </p>
                    </div>
                    <hr>
                <div class="row">
                    <h1>Infographics</h1>
                    <div>
                        <img src="static/figures/piechart.jpg" alt="piechart">
                    </div>
                </div>
            </div>

            <div class="col-6">
                <div id="mapid" class="mb-3">map</div>
                <form enctype="multipart/form-data" method="get" action="/download_data">
                    <button class = 'download-data-button btn-info btn' type="submit">Download all the data</button>
                </form>
                <div>
                    <hr>
                    <table class="table table-sortable">
                        <thead>
                            <tr>
                                <th>Name of the mill</th>
                                <th>Submission date</th>
                                <th>Opening hours</th>
                                <th>Owner of the mill</th>
                                <th>Machine count</th>
                                <th>Mill owner</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for submission in submissions['value'] %}
                            <tr>
                                <td>{{ submission['mills']['name_mill'] }}</td> 
                                <td>{{ submission['today'] }}</td> 
                                <td>{{ submission['Location']['opening_hours'] }}</td> 
                                <td>{{ submission['interviewee']['owner_name'] }}</td> 
                                <td>{{ submission['machines']['machine_count'] }}</td> 
                                <td>{{ submission['interviewee']['mill_owner'] }}</td> 
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <hr>
<!--                         {% for i in range(0, submissions_len) %}
                        <p>{{
                             submissions_machine['value'][i]
                            }}
                        </p> 
                        {% endfor %} -->

                </div>
            </div>
            <div class="col-3">
                <h1>Filters</h1>
                <div>
                    {{ subm_machine_pd }}
                </div>
                <form method="get" action="#">
<!--                     <input class = ''type="checkbox">Operation</input>
                    <input class = ''type="checkbox">Not operational</input> -->
<!--                     {% for option in (submissions_machine['value']['Commodity_milled']) %}
                    <input class = ''type="checkbox">{{ option }}</input>
                    {% endfor %} -->
                </form>
            </div>
        </div>
    </div>
<script>

  // center of the map
var center = [0.0, 20];
// Create the map
var map = new L.map('mapid').setView(center, 3);
// Set up the OSM layer
L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Data Â© <a href="http://osm.org/copyright">OpenStreetMap</a>',
    maxZoom: 18,
  }).addTo(map);


var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; <a href="https://openstreetmap.org/copyright" target="_blank">OpenStreetMap contributors' +
        '</a> ',
    tileSize: 256,
});
var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3']
});
var googleTer = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3']
});
var hotLayer = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
    maxZoom: 20,
})
var baseMaps = {
    "OpenStreetMap": osmLayer,
    "Google Satellite": googleSat,
    "Google Terrain": googleTer,
    "HOTOSM": hotLayer
} //here more layers: https://www.tutorialspoint.com/leafletjs/leafletjs_getting_started.htm

L.control.layers(baseMaps).addTo(map);
osmLayer.addTo(map);
// add a scale at at your map.
var scale = L.control.scale().addTo(map);

var markers = L.featureGroup();
markers.addTo(map);

{% for i in range(0, (submissions_len)) %}
    
    var submission ={{submissions.value[i]|tojson}}
    try {
        var coordinates = submission['Location']['mill_gps']['coordinates']
    }
    catch(err) {
        console.log("No GPS coordinates found for the submission", submission)
    }
    color = 'blue'
    // {% if  submissions_machine['value'][i]['operational_mill'] == 'yes'%}
    //     var color = 'green';
    // {% else %}
    //     var color = 'red';
    // {% endif %}
    var lng = coordinates[1]
    var lat = coordinates[0]
    var marker = L.circleMarker([lng, lat],{stroke: false, fillOpacity: 0.8});
    marker.setStyle({fillColor: color});
    markers.addLayer(marker);

    var submission_id = {{ submissions['value'][i]['__id']|tojson }}
    var machines = {{ submissions_machine['value']|tojson }}
    
    console.log(machines)
    {% for machine in machines %}
        console.log(machine)
    {% endfor %}
    // const machine_list = []
    // {% for machine in submissions_machine %}
    //     console.log(machine)
    // {% endfor %}

    toolTip = 
        "<dt>Number of milling machines: {{ submissions['value'][i]['mills']['number_milling_machines'] }}</dt>" +
        "<dt>Submissions ID: {{ submissions_machine['value'][i]['__Submissions-id']}}</dt>" + 
        // "<dt>Mill type: {{ submissions_machine['value'][i]['mill_type']}}</dt>" + 
        // "<dt> Mill is operational: {{ submissions_machine['value'][i]['operational_mill'] }} </dt>"
    marker.bindTooltip(toolTip);
{% endfor %}

map.fitBounds(markers.getBounds());
/**
*
* @param{HTMLTableElement} table to sort
* @param{number} index of the column to sort
* @param{boolean} determines if the sorting will be ascending order
* 
**/
function sortTableByColumn(table, column, asc = true){
    const dirModifier = asc ? 1 : -1;
    const tBody = table.tBodies[0];
    const rows = Array.from(tBody.querySelectorAll('tr'));

    //sort each row
    const sortedRows = rows.sort((a,b) => {
        const aColText = a.querySelector(`td:nth-child(${ column + 1 })`).textContent.trim();
        const bColText = b.querySelector(`td:nth-child(${ column + 1 })`).textContent.trim();
        return aColText > bColText ? (1 * dirModifier) : (-1 * dirModifier);
    });

    // Remove all existing TRs from the table
    while (tBody.firstChild){
        tBody.removeChild(tBody.firstChild);
    }

    // Add the newly sorted rows
    tBody.append(...sortedRows);

    // Remember how the column is currently sorted
    table.querySelectorAll('th').forEach(th => th.classList.remove("th-sort-asc", "th-sort-desc"));
    table.querySelector(`th:nth-child(${ column + 1})`).classList.toggle("th-sort-asc", asc)
    table.querySelector(`th:nth-child(${ column + 1})`).classList.toggle("th-sort-desc", !asc)
}

document.querySelectorAll(".table-sortable th").forEach(headerCell => {
    headerCell.addEventListener("click", () =>{
        const tableElement = headerCell.parentElement.parentElement.parentElement;
        const headerIndex = Array.prototype.indexOf.call(headerCell.parentElement.children, headerCell);
        const currentIsAscending = headerCell.classList.contains('th-sort-asc');

        sortTableByColumn(tableElement, headerIndex, !currentIsAscending);
   });
});
//sortTableByColumn(document.querySelector('table'),1)
</script>

</body>
</html>

{% endblock content %}
