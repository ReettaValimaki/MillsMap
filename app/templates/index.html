{% extends "layout.html" %}
{% block content %}
<html>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-3" id="sidebar"> 
                <div class="row">
                    <div class="col-11 " >
                        <div class="wrapper p-4">
                        
                            <nav >
                                <div class="row">
                                    <div class="col-8">
                                        <img class="omdtz-logo" src="static/static_figures/OMDTZ-logo.png" alt="OMDTZ-logo">
                                    </div>
                                    <div class="col-4">
                                        <img class="wfp-logo" src="static/static_figures/WFP.jpeg" alt="WFP-logo">
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <h1>Nationwide Mills Census in Tanzania</h1>
                                         <p>OpenMap Development Tanzania (OMDTZ), supported by WFP Tanzania, is conducting a national-wide mills census from August through November 2021. The project aims at mapping approximately 13,000 mills and additional mills found in the field by collecting Geographical Positioning System (GPS) coordinates, operation, production capacity, type of mills, commodity milled, flour fortification, and other relevant information. Community mapping methodology employed for the mapping and data set will be available openly through here and  Openstreetmaps 
                                        </p>
                                    </div>
                                    <hr>
                                    <div>
                                        <h3>Find OMDTZ in social media: </h3>
                                        <p class="social-share">
                                            <a  class="social-media-icon m-3" href="https://www.linkedin.com/company/openmap-development-tanzania-omdtz"><image alt="linkedin"src="static/static_figures/social_media_icons/social-1_round-linkedin.svg"></a>
                                            <a  class="social-media-icon m-3" href="https://www.facebook.com/OMDTZ"><img alt="facebook" src="static/static_figures/social_media_icons/social-1_round-facebook.svg"></a>
                                            <a  class="social-media-icon m-3" href="https://twitter.com/OMDTZ"><img alt="twitter" src="static/static_figures/social_media_icons/social-1_round-twitter.svg"></a>
                                            <a  class="social-media-icon m-3" href="https://www.instagram.com/omdtz/?hl=en"><img alt="instagram" src="static/static_figures/social_media_icons/social-1_round-instagram.svg"></a>
                                        </p>

                                    </div>
                            </nav>
                        </div>
                    </div>                   
                    <div class="col-1">
                        <button type="button" id="sidebarCollapse" class="btn btn-info">
                            <span id="left-arrow">&#10096;&#10096;</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-1 hide" id="right-arrow">
                <button type="button" id="sidebarOpen" class="btn btn-info">
                    <span>&#10095;&#10095;</span>
                </button>
            </div>

            <div class="col-6 mt-5" id="mapbar">
                <span class="ouro" id="spin">
                    <span class="left"><span class="anim"></span></span>
                    <span class="right"><span class="anim"></span></span>
                </span>
                <div id="mapid" class="mb-3">
                </div>


            </div>


        </div>

    </div>
    <hr>
    <div class="container">
        <div class="row">
            <h1>Statistics</h1>
            <div class="col-6">
                <div class="card m-5 shadow p-3 mb-5 bg-white rounded">
                    <h3  class="card-title text-center">Functional mills</h3>
                    <img src="static/figures/piechart.jpg" alt="piechart of functionality">
                </div>
                <div class="card m-5 shadow p-3 mb-5 bg-white rounded">
                    <h3  class="card-title text-center">Mill types</h3>
                    <img src="static/figures/barplot.jpg" alt="mill type barplot">
                </div>
            </div>
            
            <div class="col-6">
                <div class="card m-5 shadow p-3 mb-5 bg-white rounded">
                    <h3  class="card-title text-center">Commodity milled</h3>
                    <img src="static/figures/barplot_commodity_milled.jpg" alt="commodity milled type barplot">
                </div>
                <div class="card m-5 shadow p-3 mb-5 bg-white rounded">
                    <h3  class="card-title text-center">Flour is fortified</h3>
                    <img src="static/figures/barplot_flour_fortified.jpg" alt="commodity milled type barplot">
                </div>
            </div>

        </div>
    </div>
       
<script type="text/javascript">


$(document).ready(function () {
    $('#sidebarCollapse').on('click', function () {
        $('#sidebar').toggleClass('hide');
        $('#mapbar').toggleClass('col-8');
        $('#left-arrow').toggleClass('hide');
        $('#right-arrow').toggleClass('hide');
    });

});

$(document).ready(function () {
    $('#sidebarOpen').on('click', function () {
        $('#sidebar').toggleClass('hide');
        $('#mapbar').toggleClass('col-8');
        $('#left-arrow').toggleClass('hide');
        $('#right-arrow').toggleClass('hide');
    });

});

var form = document.getElementById('filterForm')

//var form_elements = document.getElementById("filterForm").elements

// document.getElementById('filterSubmit').addEventListener("click", function(){
//     event.preventDefault();

    //console.log(form.elements['maleField'].checked);
    //console.log(document.forms[1])
    //var formData = new FormData(form[0])
    //console.log('test' + formData.get('femaleField'))


    // var form_elements = document.getElementById("filterForm").elements 
    // alert(data)
    // console.log(data)

    // var form_data = new FormData(data[0])
    // alert(data.get('male'))

//}); 

  // center of the map
var center = [-6.23, 34.9];
// Create the map
var map = new L.map('mapid', {
    fullscreenControl: true
    }).setView(center, 6);
// Set up the OSM layer
L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Data Â© <a href="http://osm.org/copyright">OpenStreetMap</a>',
    maxZoom: 18,
  }).addTo(map);
// L.tileLayer.bing(bing_key).addTo(map)
//var bing = new L.BingLayer(bing_key);


var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; <a href="https://openstreetmap.org/copyright" target="_blank">OpenStreetMap contributors' +
        '</a> ',
    tileSize: 256,
});
var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3']
});
var googleTer = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3']
});
var hotLayer = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
    maxZoom: 20,
})
var mqi = L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{LOD}/{X}/{Y}.png", {
    subdomains: ['otile1','otile2','otile3','otile4']
});
var baseMaps = {
    "OpenStreetMap": osmLayer,
    "Google Satellite": googleSat,
    "Google Terrain": googleTer,
    "HOTOSM": hotLayer
} //here more layers: https://www.tutorialspoint.com/leafletjs/leafletjs_getting_started.htm

L.control.layers(baseMaps).addTo(map);
osmLayer.addTo(map);

// add a scale at at your map.
var scale = L.control.scale().addTo(map);

var markers = new L.MarkerClusterGroup();

//var markers = L.featureGroup();
markers.addTo(map);


promise = $.get('/mill_points')
promise.then(function(submissions_filtered) {
    var element = document.getElementById("spin");
    element.classList.toggle("hide");

    var submissions_filtered_json = JSON.parse(submissions_filtered)

    for (submission_index in submissions_filtered_json){
        var submission = submissions_filtered_json[submission_index]
        try {
            var coordinates = submission['coordinates']
        }
        catch(err) {
            console.log("No GPS coordinates found for the submission", submission)
        }
        color = 'blue'

        var lng = coordinates[1]
        var lat = coordinates[0]
        var marker = L.circleMarker([lng, lat],{stroke: false, fillOpacity: 0.8});
        marker.setStyle({fillColor: color});
        markers.addLayer(marker);

        var toolTip = 
            "<dt>Number of milling machines:" + submission['number_milling_machines'] + "</dt>" 
        toolTip += "<hr>"
        console.log(submission['machines'])
        counter = 0
        for (machine_index in submission['machines']){
            console.log(submission['machines']['machine_index'])
            counter += 1
            toolTip += "<dt> Machine: " + counter + "</dt>";
            toolTip += "<div> ID: " + submission['machines'][machine_index]['__id'] + "</div>";
            toolTip += "<div> Type of mill: ";
            toolTip += submission['machines'][machine_index]['mill_type'] + "</div>";
            toolTip += "<div> Operational: ";
            toolTip += submission['machines'][machine_index]['operational_mill'] + "</div>";
            toolTip += "<div> Energy source: ";
            toolTip += submission['machines'][machine_index]['energy_source'] + "</div>";

            //console.log(submission['machines'][machine_index]['energy_source'])
            //console.log(submission['machines'][machine_index])
        }
        marker.bindTooltip(toolTip);

    }
    
    map.isFullscreen() // Is the map fullscreen?
    map.toggleFullscreen() // Either go fullscreen, or cancel the existing fullscreen.
    L.Control.Fullscreen
    map.fitBounds(markers.getBounds())
});

 
// // `fullscreenchange` Event that's fired when entering or exiting fullscreen.
// map.on('fullscreenchange', function () {
//     if (map.isFullscreen()) {
//         console.log('entered fullscreen');
//     } else {
//         console.log('exited fullscreen');
//     }
// });
 

/**
*
* @param{HTMLTableElement} table to sort
* @param{number} index of the column to sort
* @param{boolean} determines if the sorting will be ascending order
* 
**/
function sortTableByColumn(table, column, asc = true){
    const dirModifier = asc ? 1 : -1;
    const tBody = table.tBodies[0];
    const rows = Array.from(tBody.querySelectorAll('tr'));

    //sort each row
    const sortedRows = rows.sort((a,b) => {
        const aColText = a.querySelector(`td:nth-child(${ column + 1 })`).textContent.trim();
        const bColText = b.querySelector(`td:nth-child(${ column + 1 })`).textContent.trim();
        return aColText > bColText ? (1 * dirModifier) : (-1 * dirModifier);
    });

    // Remove all existing TRs from the table
    while (tBody.firstChild){
        tBody.removeChild(tBody.firstChild);
    }

    // Add the newly sorted rows
    tBody.append(...sortedRows);

    // Remember how the column is currently sorted
    table.querySelectorAll('th').forEach(th => th.classList.remove("th-sort-asc", "th-sort-desc"));
    table.querySelector(`th:nth-child(${ column + 1})`).classList.toggle("th-sort-asc", asc)
    table.querySelector(`th:nth-child(${ column + 1})`).classList.toggle("th-sort-desc", !asc)
}

document.querySelectorAll(".table-sortable th").forEach(headerCell => {
    headerCell.addEventListener("click", () =>{
        const tableElement = headerCell.parentElement.parentElement.parentElement;
        const headerIndex = Array.prototype.indexOf.call(headerCell.parentElement.children, headerCell);
        const currentIsAscending = headerCell.classList.contains('th-sort-asc');

        sortTableByColumn(tableElement, headerIndex, !currentIsAscending);
   });
});
//sortTableByColumn(document.querySelector('table'),1)
</script>
</body>
</html>

{% endblock content %}
